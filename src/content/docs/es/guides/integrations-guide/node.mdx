---
type: integration
title: '@astrojs/node'
description: Aprende como usar el adaptador SSR @astrojs/node para desplegar tu proyecto de Astro.
sidebar:
  label: Node
githubIntegrationURL: 'https://github.com/withastro/astro/tree/main/packages/integrations/node/'
category: adapter
i18nReady: true
---

import PackageManagerTabs from '~/components/tabs/PackageManagerTabs.astro'
import Since from '~/components/Since.astro';

Este adaptador permite a Astro desplegar tus [rutas y características renderizadas bajo demanda](/es/guides/on-demand-rendering/) a objetivos de Node, incluyendo [islas del servidor](/es/guides/server-islands/), [acciones](/es/guides/actions/), y [sesiones](/es/guides/sessions/).

Si estás usando Astro como un constructor de sitios estáticos, no necesitas un adaptador.

## Por qué Astro Node.js

[Node.js](https://nodejs.org/es/) es un entorno de ejecución de JavaScript para código del lado del servidor. @astrojs/node puede utilizarse en modo standalone o como middleware para otros servidores http, como [Express](https://expressjs.com/).

## Instalación

Astro incluye un comando `astro add` para automatizar la configuración de las integraciones oficiales. Si lo prefieres, puedes [instalar las integraciones manualmente](#instalación-manual) en su lugar.

Agrega el adaptador de Node para habilitar SSR en tu proyecto Astro con el comando `astro add`.
Esto instalará `@astrojs/node` y hará los cambios apropiados en tu archivo `astro.config.*` en un solo paso.

<PackageManagerTabs>
  <Fragment slot="npm">
  ```sh
  npx astro add node
  ```
  </Fragment>
  <Fragment slot="pnpm">
  ```sh
  pnpm astro add node
  ```
  </Fragment>
  <Fragment slot="yarn">
  ```sh
  yarn astro add node
  ```
  </Fragment>
</PackageManagerTabs>

Ahora, puedes habilitar [el renderizado bajo demanda por página](/es/guides/on-demand-rendering/#habilitar-el-renderizado-bajo-demanda), o establecer la configuración de salida de tu construcción en `output: 'server'` para [renderizar todas tus páginas en el servidor por defecto](/es/guides/on-demand-rendering/#modo-server).

### Instalación manual

Primero, agrega el adaptador de Node a las dependencias de tu proyecto usando tu gestor de paquetes preferido.

<PackageManagerTabs>
  <Fragment slot="npm">
  ```sh
  npm install @astrojs/node
  ```
  </Fragment>
  <Fragment slot="pnpm">
  ```sh
  pnpm add @astrojs/node
  ```
  </Fragment>
  <Fragment slot="yarn">
  ```sh
  yarn add @astrojs/node
  ```
  </Fragment>
</PackageManagerTabs>

Luego, agrega el adaptador a tu archivo astro.config.*:

```js title="astro.config.mjs" ins={2,5-7}
import { defineConfig } from 'astro/config';
import node from '@astrojs/node';

export default defineConfig({
  adapter: node({
    mode: 'standalone',
  }),
});
```

## Configuración

@astrojs/node puede ser configurado pasando opciones al adaptador. Las siguientes opciones están disponibles:

### `mode`
<p>
**Tipo:** `'middleware' | 'standalone'` <br />
</p>

Controla si el adaptador construye en modo `middleware` o `standalone`.

* El modo `middleware` permite que la salida generada se utilice como middleware para otro servidor de Node.js, como Express.js o Fastify.
* El modo `standalone` construye un servidor que se inicia automáticamente cuando se ejecuta el módulo de entrada. Esto te permite desplegar tu compilación en un host con mayor facilidad, sin necesidad de código adicional.

```js title="astro.config.mjs" {6}
import { defineConfig } from 'astro/config';
import node from '@astrojs/node';

export default defineConfig({
  adapter: node({
    mode: 'middleware',
  }),
});
```

### `experimentalDisableStreaming`

<p>
**Tipo:** `boolean` <br />
**Predeterminado:** `false`<br />
<Since v="9.3.0" pkg="@astrojs/node" />
</p>

Desactiva el [streaming de HTML](/es/guides/on-demand-rendering/#transmisión-de-html) por defecto de Astro para las páginas renderizadas bajo demanda.

El streaming de HTML ayuda con el rendimiento y generalmente proporciona una mejor experiencia al visitante. En la mayoría de los casos, no se recomienda desactivar el streaming.

Sin embargo, cuando necesitas desactivar el streaming de HTML (por ejemplo, si tu host solo admite almacenamiento en caché de HTML no transmitido a nivel de CDN), puedes optar por no utilizar el comportamiento predeterminado:

```js title="astro.config.mjs" {7}
import { defineConfig } from 'astro/config';
import node from '@astrojs/node';

export default defineConfig({
  adapter: node({
    mode: 'standalone',
    experimentalDisableStreaming: true,
  }),
});
```

### `experimentalStaticHeaders`

<p>
  **Tipo:** `boolean` <br />
  **Predeterminado:** `false`<br />
  <Since v="9.3.0"  pkg="@astrojs/node"/>
</p>

Si está habilitado, el adaptador servirá los encabezados de las páginas prerenderizadas utilizando el objeto `Response` cuando lo proporcionen las funciones de Astro, como la Política de Seguridad de Contenido.

Por ejemplo, cuando se habilita [la Política de Seguridad de Contenido experimental](/es/reference/experimental-flags/csp/), se puede utilizar `experimentalStaticHeaders` para agregar los encabezados de CSP al objeto `Response` en lugar de crear un elemento `<meta>`:

```js title="astro.config.mjs" {10}
import { defineConfig } from 'astro/config';
import node from '@astrojs/node';

export default defineConfig({
  experimental: {
    csp: true
  },
  adapter: node({
    mode: 'standalone',
    experimentalStaticHeaders: true,
  })
});
```

## Uso

Primero, [realiza una compilación](/es/guides/deploy/#construyendo-tu-proyecto-localmente). Dependiendo de qué `modo` se seleccione (ver arriba), sigue los pasos apropiados a continuación:

### Middleware

El punto de entrada del servidor se construye en `./dist/server/entry.mjs` por defecto. Este módulo exporta una función `handler` que se puede utilizar con cualquier framework que admita los objetos `request` y `response` de Node.

Por ejemplo, con Express:

```js title="run-server.mjs"
import express from 'express';
import { handler as ssrHandler } from './dist/server/entry.mjs';

const app = express();
// Modifica esto en función de la opción `base` de tu archivo astro.config.mjs.
// Deben coincidir. El valor predeterminado es "/".
const base = '/';
app.use(base, express.static('dist/client/'));
app.use(ssrHandler);

app.listen(8080);
```

O, con Fastify (>4):

```js title="run-server.mjs"
import Fastify from 'fastify';
import fastifyMiddie from '@fastify/middie';
import fastifyStatic from '@fastify/static';
import { fileURLToPath } from 'node:url';
import { handler as ssrHandler } from './dist/server/entry.mjs';

const app = Fastify({ logger: true });

await app
  .register(fastifyStatic, {
    root: fileURLToPath(new URL('./dist/client', import.meta.url)),
  })
  .register(fastifyMiddie);
app.use(ssrHandler);

app.listen({ port: 8080 });
```

Además, también puedes pasar un objeto que se podrá acceder mediante `Astro.locals` o en el middleware de Astro:

```js title="run-server.mjs"
import express from 'express';
import { handler as ssrHandler } from './dist/server/entry.mjs';

const app = express();
app.use(express.static('dist/client/'));
app.use((req, res, next) => {
  const locals = {
    title: 'Nuevo título',
  };

  ssrHandler(req, res, next, locals);
});

app.listen(8080);
```

Ten en cuenta que el modo middleware no se encarga de servir archivos. Deberás configurar tu framework HTTP para que lo haga por ti. Por defecto, los assets del cliente se escriben en `./dist/client/`.

### Standalone

En el modo standalone, un servidor se inicia cuando se ejecuta el punto de entrada del servidor. Por defecto, se construye en `./dist/server/entry.mjs`. Puedes ejecutarlo con:

```sh
node ./dist/server/entry.mjs
```

En el modo standalone, el servidor se encarga de servir archivos además de las rutas de página y API.

#### Host y puerto personalizados

Puedes sobrescribir el host y el puerto en los que se ejecuta el servidor standalone pasándolos como variables de entorno en tiempo de ejecución:

```sh
HOST=0.0.0.0 PORT=4321 node ./dist/server/entry.mjs
```

#### HTTPS

Por defecto, el servidor standalone utiliza HTTP. Esto funciona bien si tienes un servidor proxy delante que maneje HTTPS. Si necesitas que el servidor standalone utilice HTTPS directamente, debes proporcionar tu clave SSL y certificado.

Puedes pasar la ruta a tu clave y certificado a través de las variables de entorno `SERVER_CERT_PATH` y `SERVER_KEY_PATH`. Así es como podrías pasarlos en bash:

```bash
SERVER_KEY_PATH=./private/key.pem SERVER_CERT_PATH=./private/cert.pem node ./dist/server/entry.mjs
```

#### Variables de entorno en tiempo de ejecución

Si hay un archivo `.env` con variables de entorno presente al momento de ejecutar el proceso de compilación, estos valores se incrustarán en el resultado final, tal como sucede al generar un sitio web estático.

Durante la compilación, las variables de tiempo de ejecución deben estar ausentes del archivo `.env`, y debes proporcionar a Astro cada variable de entorno que se espera en tiempo de ejecución: `VARIABLE_1=placeholder astro build`. Esto le indica a Astro que el valor real estará disponible cuando se ejecute la aplicación construida. El valor de marcador de posición será ignorado por el proceso de compilación, y Astro utilizará el valor proporcionado en tiempo de ejecución.

En el caso de múltiples variables de tiempo de ejecución, guárdalas en un archivo separado (por ejemplo, `.env.runtime`) de `.env`. Inicia la compilación con el siguiente comando:

```sh
export $(cat .env.runtime) && astro build
```

#### Assets

En el modo standalone, los assets en tu carpeta `dist/client/` son servidos a través del servidor standalone. Es posible que estés desplegando estos assets en un CDN, en cuyo caso el servidor nunca los estará sirviendo realmente. Pero en algunos casos, como en sitios de intranet, está bien servir assets estáticos directamente desde el servidor de la aplicación.

Los assets en la carpeta `dist/client/_astro/` son los que Astro ha construido. Estos assets están todos nombrados con un hash y, por lo tanto, se les pueden dar encabezados de caché prolongados. Internamente, el adaptador agrega este encabezado para estos assets:

```
Cache-Control: public, max-age=31536000, immutable
```

## Sesiones

La [API de Sesiones](/es/guides/sessions/) de Astro te permite almacenar fácilmente datos de usuario entre solicitudes. Esto se puede utilizar para cosas como datos y preferencias de usuario, carritos de compras y credenciales de autenticación. A diferencia del almacenamiento en cookies, no hay límites de tamaño en los datos, y se pueden restaurar en diferentes dispositivos.

Astro utiliza el sistema de archivos local para el almacenamiento de sesiones cuando se utiliza el adaptador de Node. Si prefieres utilizar un controlador de almacenamiento de sesiones diferente, puedes especificarlo en tu configuración de Astro. Consulta [la referencia de configuración `session`](/es/reference/configuration-reference/#sessiondriver) para obtener más detalles.